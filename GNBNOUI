local players = game:GetService("Players")
repeat task.wait() until players.LocalPlayer
local localplayer = players.LocalPlayer

local zombieESP = {}
local playerESP = {}
local zombieSpawnESP = {}

print("[ESP] Loaded!")

local function newText(text, color)
    local txt = Drawing.new("Text")
    txt.Text = text
    txt.Center = true
    txt.Outline = true
    txt.Size = 14
    txt.Color = color
    txt.Visible = false
    return txt
end

local function getRoot(model)
    local p = model:FindFirstChild("HumanoidRootPart")
    if p and p:IsA("BasePart") then return p end
    for _, v in ipairs(model:GetChildren()) do
        if v:IsA("BasePart") then return v end
    end
end

while true do
    local zombieFolder = workspace:FindFirstChild("Zombies")
    local spawnFolder = workspace:FindFirstChild("ZombieSpawns")

    local zA = {}
    if zombieFolder then
        for _, m in ipairs(zombieFolder:GetChildren()) do
            if not m:IsA("Model") or not m.Parent then continue end
            local root = getRoot(m)
            if not root or not root.Parent then continue end
            local pos, vis = WorldToScreen(root.Position)
            if not pos then continue end
            if not zombieESP[m] then zombieESP[m] = newText("Zombie", Color3.fromRGB(0, 255, 0)) end
            zombieESP[m].Visible = vis
            if vis then zombieESP[m].Position = pos - Vector2.new(0, 15) end
            zA[m] = true
        end
    end
    for m, t in pairs(zombieESP) do
        if not zA[m] then t:Remove() zombieESP[m] = nil end
    end

    local pA = {}
    for _, plr in ipairs(players:GetPlayers()) do
        if plr == localplayer or plr.Name == localplayer.Name then continue end
        if not plr.Character then continue end
        local root = plr.Character:FindFirstChild("HumanoidRootPart")
        if not root then continue end
        local hum = plr.Character:FindFirstChild("Humanoid")
        if not hum or hum.Health <= 0 then continue end
        local pos, vis = WorldToScreen(root.Position)
        if not pos then continue end
        if not playerESP[plr] then playerESP[plr] = newText(plr.Name, Color3.fromRGB(255, 255, 255)) end
        playerESP[plr].Visible = vis
        if vis then playerESP[plr].Position = pos - Vector2.new(0, 15) end
        pA[plr] = true
    end
    for plr, t in pairs(playerESP) do
        if not pA[plr] then t:Remove() playerESP[plr] = nil end
    end

    local sA = {}
    if spawnFolder then
        for _, spawn in ipairs(spawnFolder:GetChildren()) do
            local part = spawn:FindFirstChild("Spawn Location") or (spawn:IsA("BasePart") and spawn)
            if not part or not part:IsA("BasePart") then continue end
            local pos, vis = WorldToScreen(part.Position)
            if not pos then continue end
            if not zombieSpawnESP[part] then zombieSpawnESP[part] = newText("[Z-SPAWN]", Color3.fromRGB(255, 165, 0)) end
            zombieSpawnESP[part].Visible = vis
            if vis then zombieSpawnESP[part].Position = pos - Vector2.new(0, 15) end
            sA[part] = true
        end
    end
    for part, t in pairs(zombieSpawnESP) do
        if not sA[part] then t:Remove() zombieSpawnESP[part] = nil end
    end

    task.wait(0.1)
end
